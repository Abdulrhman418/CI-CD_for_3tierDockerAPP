name: CI

on:
    pull_request:
        branches:
            - main

defaults:
    run:
        shell: bash

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - uses: actions/setup-python@v4
              with:
                  python-version: 3.12

            - name: Install API dependencies
              run: |
                  pip install -r api/req.txt

            - name: Run API tests
              run: |
                  cd api
                  python -m pytest tests/ -v

            - name: Install Web dependencies
              run: |
                  pip install -r web/req.txt

            - name: Run Web tests
              run: |
                  cd web
                  python -m pytest tests/ -v

    build:
        runs-on: ubuntu-latest
        needs: test
        env:
            DB_HOST: ${{ vars.DB_HOST }}
            DB_USER: ${{ vars.DB_USER }}
            DB_NAME: ${{ vars.DB_NAME }}
            API_HOST: ${{ vars.API_HOST }}

        steps:
            - uses: actions/checkout@v3

            - name: Init Docker Swarm
              run: docker swarm init || true

            - name: Build images
              run: |
                  docker build -t stack/api ./api
                  docker build -t stack/web ./web

            - name: Create Docker secret
              run: |
                  echo "${{ secrets.MYSQL_ROOT_PASSWORD }}" | \
                  docker secret create MYSQL_ROOT_PASSWORD - || true

            - name: Deploy Docker Stack
              run: |
                  docker stack deploy -c docker-stack.yml myapp
            - name: Wait for API to be ready
              run: |
                until curl -sf http://localhost:5000/health; do
                  echo "Waiting for API..."
                  sleep 5
                done

            - name: Wait for Web to be ready
              run: |
                until curl -sf http://localhost:8080/; do
                  echo "Waiting for Web..."
                  sleep 5
                done
            - name: Integration test
              run: |
                curl -f http://localhost:8080/ || exit 1
                curl -f http://localhost:5000/products || exit 1                 

            - name: Push to DockerHub
              env:
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
              run: |
                  echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
                  docker tag stack/api:latest $DOCKERHUB_USERNAME/stack-api:latest
                  docker tag stack/web:latest $DOCKERHUB_USERNAME/stack-web:latest
                  docker push $DOCKERHUB_USERNAME/stack-api:latest
                  docker push $DOCKERHUB_USERNAME/stack-web:latest
